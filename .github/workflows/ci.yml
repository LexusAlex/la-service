name: la-service pipeline
on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: true
      matrix:
        php-versions: ['8.1']
    steps:
      - name: Git checkout placeholder-service
        uses: actions/checkout@v2
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-versions }}
          coverage: none
          tools: composer:v2
          extensions: mbstring
      - name: Check PHP Version
        run: php -v
      - name: Get composer cache directory
        id: composer-cache
        run: echo "::set-output name=dir::$(composer config cache-files-dir)"

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install dependencies
        run: composer install --working-dir=backend
      #  run: composer install --working-dir=/backend/
      - name: Run test
        run: composer --working-dir=backend test
  build:
    runs-on: ubuntu-20.04
    steps:
    - name: checkout project
      uses: actions/checkout@v2
    # Подготовительная работа к деплою phpunit, linter, тесты и прочее и последнее что надо сделать это вылить на прод
    - name: push on production server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.REMOTE_HOST }}
        port: ${{ secrets.REMOTE_PORT }}
        username: ${{ secrets.REMOTE_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script_stop: true
        script: |
          git -C ${{ secrets.REMOTE_PATH }} pull
          composer install --working-dir=${{ secrets.REMOTE_PATH }}/backend/ --no-dev --optimize-autoloader --classmap-authoritative